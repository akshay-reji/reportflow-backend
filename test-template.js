// test-template.js - Save in main directory
const axios = require('axios');

const TENANT_UUID = '3bce31b7-b045-4da0-981c-db138e866cfe';
const CONFIG_ID = 'e51bc18e-a9f4-4501-a33f-6b478b689289';
const API_URL = 'http://localhost:3001';

const headers = {
  'x-tenant-id': TENANT_UUID,
  'Content-Type': 'application/json'
};

async function testTemplateSystem() {
  console.log('=== ReportFlow Template System Test ===');
  console.log(`Tenant: ${TENANT_UUID}`);
  console.log(`Config: ${CONFIG_ID}\n`);

  try {
    // 1. Health check
    console.log('1. Checking server health...');
    const health = await axios.get(`${API_URL}/api/health`);
    console.log('Health:', health.data, '\n');

    // 2. Create template
    console.log('2. Creating a test template...');
    const templateData = {
      name: 'Test Template - Modern Analytics',
      html_content: '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>{{client_name}} Report</title><style>body{font-family: Arial, sans-serif; margin: 40px; line-height: 1.6;} .header{background: #2563eb; color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px;} h1{margin: 0;} .section{margin: 25px 0; padding: 20px; border: 1px solid #e5e7eb; border-radius: 8px;} .metric{display: inline-block; margin: 15px; padding: 15px; background: #f8fafc; border-radius: 6px; min-width: 150px;} .metric-value{font-size: 24px; font-weight: bold; color: #2563eb;} footer{margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb; color: #6b7280; font-size: 14px;}</style></head><body><div class="header"><h1>{{client_name}} Analytics Report</h1><p>Period: {{period}} | Generated: {{formatDate generated_at}}</p></div><div class="content">{{#each metrics}}<div class="metric"><div class="metric-label">{{this.name}}</div><div class="metric-value">{{formatNumber this.value}}</div>{{#if this.description}}<div class="metric-desc">{{this.description}}</div>{{/if}}</div>{{/each}}</div><footer><p>Generated by ReportFlow | {{formatDate generated_at}}</p></footer></body></html>',
      category: 'analytics',
      description: 'Test template for development'
    };

    const createResponse = await axios.post(`${API_URL}/api/templates`, templateData, { headers });
    const templateId = createResponse.data.template.id;
    console.log(`Created Template ID: ${templateId}\n`);

    // 3. List templates
    console.log('3. Listing all templates...');
    const listResponse = await axios.get(`${API_URL}/api/templates`, { headers });
    console.log(`Total templates: ${listResponse.data.templates?.length || 0}\n`);

    // 4. Activate template
    console.log('4. Activating template...');
    const activateResponse = await axios.put(`${API_URL}/api/templates/${templateId}/activate`, {}, { headers });
    console.log('Activation:', activateResponse.data.message || 'Success', '\n');

    // 5. Generate report
    console.log('5. Generating report with template...');
    const reportData = {
      tenant_id: TENANT_UUID,
      report_config_id: CONFIG_ID,
      template_id: templateId
    };

    const generateResponse = await axios.post(`${API_URL}/api/reporter/generate`, reportData, { headers });
    console.log('Generate Response:', generateResponse.data);

    if (generateResponse.data.report_url || generateResponse.data.pdf_url) {
      console.log('\n✅ SUCCESS: Report generated!');
      console.log('Report URL:', generateResponse.data.report_url || generateResponse.data.pdf_url);
    } else {
      console.log('\n⚠️ Report generation response:', JSON.stringify(generateResponse.data, null, 2));
    }

  } catch (error) {
    console.error('\n❌ ERROR:', error.message);
    if (error.response) {
      console.error('Response data:', error.response.data);
      console.error('Status:', error.response.status);
    }
  }

  console.log('\n=== Test Complete ===');
}

// Run the test
testTemplateSystem();